# 仮想地図生成サイト（Day010）
ベクター形式で仮想地図を生成し、SVGとしてダウンロード可能にすることを目指すプロジェクト。  
現時点では、地形描画パイプラインの骨格を整理している段階。

## このプロジェクトの目的
- 目的: 仮想地図を段階的に生成する描画パイプラインを設計・実装する。
- 今回の範囲: 海岸線生成、等高線作成、色塗りの3段階。
- 今回の非範囲: 国境や国家単位の生成は一旦実施しない。

## 描画手順
1. 海岸線生成
   - 入力: 乱数シード、地形サイズ、粗さに関するパラメータ（TODO: パラメータ名を確定）
   - 出力: 島/大陸の輪郭ポリゴン
2. 等高線作成
   - 入力: 海岸線輪郭、高さ分布のルール（TODO: 生成ロジックを確定）
   - 出力: 高度ごとの線群
3. 色塗り
   - 入力: 等高線、海/陸の分類情報（TODO: 色マップ仕様を確定）
   - 出力: SVG描画用の色付きレイヤー

===ゆくゆくは===
4. 別レイヤーで気候分布

## 実装メモ
### 海岸線の生成
3stepで生成する。
1. 大まかな構造を作成する。
   全体として、メルカトル図法のように、横長のマップにする。
   大陸の大きさもばらつきをいれる。
   左右はトーラス状にして、陸の面積と海の面積比は3:7になるように。
2. 島を作成する。
	島は大陸に被らないように。
	群島のような構造ができるように、偏りを持たせる.
3. フラクタルで細かい構造を追加する。

### 等高線の作成
海岸線形状に沿った自然な起伏を作り、機械的な同心円や不自然な断絶を減らす。

1. 入力と前処理
- 入力: 最終陸マスク、海岸線境界、乱数シード、等高線本数。
- 前処理: 陸マスクに対して「海岸からの距離場」を作る（海=0、内陸ほど大）。
- 前処理: 湖は海と同じ基準面として扱い、湖岸からも距離が増えるようにする。

2. 標高モデル（Tectonic-first）
- 基本方針: `Elevation-first` ではなく `Tectonic-first` にする。
- 先に「プレート境界場」を作り、標高はその結果として合成する。
- 収束境界（convergent）を山脈の主因とし、海岸近傍にも通すことでアンデス型地形を作る。
- 最終標高は次の合成とする。  
  `elevation = a * coastBase + b * tectonicRidge + c * basin + d * detailNoise`
- `coastBase` は海岸0基準を保つ弱い基底項として扱い、支配項にしない。
- `tectonicRidge` は長距離で連続する線状リッジ場。主峰・副峰を境界沿いに形成する。
- `basin` は内陸低地を残す減算項。山脈と競合して地形の単調化を防ぐ。
- `detailNoise` は局所粗さのみ担当し、地形骨格は壊さない強度に制限する。

3. プレート境界場
- 境界は2〜4本の長い折れ線（またはスプライン）として生成する。
- 各境界にタイプを持たせる（最低限: `convergent`, `transform`, `divergent`）。
- `convergent` 境界のみ強い正の寄与を持ち、山脈帯を形成する。
- 境界ごとに幅・強度・連続性を持ち、seedで再現可能な揺らぎを与える。
- 海岸近傍を通る `convergent` 境界を一定確率で必ず生成する（沿岸山脈条件）。

4. 等高線抽出
- 等高線レベルは線形分割ではなく、低地に密、山地に疎の間隔も選べる設計にする。
- 各レベルで閾値マスクを作成し、境界抽出してポリライン化する。
- 小さすぎる閉曲線は面積閾値で除去する（ノイズ線の除去）。
- 線の簡略化は Douglas-Peucker 相当を使い、形状維持優先で頂点数を削減する。
- 追加要件: 等高線にもフラクタル変形を適用する。
  - ただし海岸線と同じ強度は使わず、弱い振幅でジッターを入れる。
  - 標高が高い等高線ほど微細さをやや強める（過剰ノイズは不可）。

5. 海岸線との整合ルール
- 海岸線そのものを標高0m相当として固定する。
- 等高線は海上へはみ出さない（陸マスク内でクリップ）。
- 海岸から最初の等高線は最小オフセット距離を持たせ、海岸線との重なりを回避する。
- 地形連結補正後の最終陸マスクを基準に等高線を生成し、段階間の不整合を防ぐ。
- 沿岸山脈を有効にする場合でも、最初の等高線が海岸線と視覚的に分離される最小距離は維持する。

6. レンダリング仕様
- 等高線は `fill="none"` のパスで重ね描きする。
- 標高が高い線ほど少し濃く/太くする（可視性のための弱い強調）。
- 描画順序は `海 -> 陸 -> 等高線` を維持する。

7. パラメータ（公開候補）
- `contourCount`: 等高線数（2..12）
- `coastBaseWeight`: 海岸距離場の重み
- `tectonicRidgeWeight`: プレート境界山脈の重み
- `noiseStrength`: ノイズ強度
- `basinStrength`: 内陸低地の掘り込み強度
- `basinScale`: 内陸低地の広がりスケール
- `coastalSmoothness`: 海岸付近の平滑化強度
- `minLoopArea`: 等高線ループの最小面積
- `contourFractalStrength`: 等高線フラクタル強度
- `convergentBoundaryCount`: 収束境界の本数
- `coastalConvergentChance`: 沿岸収束境界を含める確率
- `boundaryWidthRange`: 境界帯の幅レンジ

8. 受け入れ条件（暫定）
- 海岸線と等高線が視覚的に分離され、重なり潰れが目立たない。
- 湖は海面扱いになり、湖内に等高線が出ない。
- 同一seedで再生成時に等高線形状が再現される。
- 1280x640での生成時間増加が許容範囲（現状比 +40%以内を目標）。
- 等高線が直線的すぎず、海岸線と同系統の自然な凹凸を持つ。
- 時々海に近い長大山脈（アンデス型）が観測できる。
- 時々大陸中央の低地が観測できる（中央部が常に高地にならない）。

### 色塗り
- 現状方針: 高度帯ごとに色を割り当て、海と陸を別パレットで描画する。
- TODO: 色境界を滑らかに補間するか、段階色で明確に分けるかを決定する。
- TODO: SVGでの描画順序（海 -> 陸 -> 等高線）を確定する。

## 技術課題
- 高度分布モデルが未確定。
  - 原因仮説: 海岸線生成と等高線生成の責務分離がまだ曖昧なため。
- パラメータ体系が未整理。
  - 原因仮説: 先に出力品質を確認しており、入力IF設計を後回しにしているため。
- SVG最終出力のレイヤー仕様が未確定。
  - 原因仮説: 色塗り仕様と等高線の視認性要件が未定義のため。

## TODO
- [x] 段階1を実装
- [ ] 段階2の実装
- [ ] 段階3を実装

## 実装方法
### 必要環境
- HTML, CSS, JS

### 出力確認方法
- TODO: 生成されたSVGの保存先を記載する。
- TODO: 最低限確認する見た目（海岸線/等高線/色塗り）を記載する。

## 参考資料
- https://www.youtube.com/watch?v=S0YB-OXlfVg
